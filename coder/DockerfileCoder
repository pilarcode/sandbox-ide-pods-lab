FROM ubuntu:22.04

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git python3 curl sudo \
        ca-certificates \
        build-essential \
        libssl-dev zlib1g-dev \
        libncurses5-dev libreadline-dev \
        libsqlite3-dev libffi-dev \
        wget xz-utils && \
    update-ca-certificates && \
    curl -fsSL https://code-server.dev/install.sh | sh && \
    useradd -m coder && usermod -aG sudo coder && \
    wget https://www.python.org/ftp/python/3.12.3/Python-3.12.3.tgz && \
    tar -xf Python-3.12.3.tgz && \
    cd Python-3.12.3 && \
    ./configure --enable-optimizations && \
    make -j$(nproc) && \
    make altinstall && \
    cd .. && rm -rf Python-3.12.3* && \
    apt-get remove -y wget build-essential && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.12 1
# Instalar Git desde fuente (última versión)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl unzip \
        libssl-dev libcurl4-gnutls-dev libexpat1-dev gettext \
        gcc make && \
    cd /tmp && \
    curl -L https://github.com/git/git/archive/refs/tags/v2.44.0.zip -o git.zip && \
    unzip git.zip && cd git-2.44.0 && \
    make prefix=/usr/local all && \
    make prefix=/usr/local install && \
    cd / && rm -rf /tmp/git* && \
    apt-get remove -y gcc make && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Instalar dependencias para terminal interactivo
RUN apt-get update && apt-get install -y \
    bash-completion \
    util-linux \
    readline-common \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/coder

# Configure bash history and autocompletion
RUN echo 'export HISTFILE=/home/coder/.bash_history' >> /home/coder/.bashrc && \
    echo 'export HISTSIZE=10000' >> /home/coder/.bashrc && \
    echo 'export HISTFILESIZE=10000' >> /home/coder/.bashrc && \
    echo 'shopt -s histappend' >> /home/coder/.bashrc && \
    echo 'PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"' >> /home/coder/.bashrc && \
    echo 'source /etc/bash_completion' >> /home/coder/.bashrc && \
    echo 'cd /home/coder' >> /home/coder/.bashrc && \
    touch /home/coder/.bash_history && \
    chown coder:coder /home/coder/.bash_history

# Create project directory and set permissions
RUN mkdir -p /home/coder/project && \
    chown -R coder:coder /home/coder


# Set up the home directory for the coder user
RUN chown -R coder:coder /home/coder/

# Expose the port that code-server uses by default
ARG PORT=8080
ENV PORT=$PORT
EXPOSE $PORT


CMD ["bash", "-c", "code-server --bind-addr 0.0.0.0:${PORT} --auth none --disable-telemetry --disable-workspace-trust"]

